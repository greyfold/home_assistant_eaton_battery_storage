name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  get-python-version:
    name: Get Home Assistant Python Version
    runs-on: ubuntu-latest
    outputs:
      python-version: ${{ steps.extract-version.outputs.python-version }}
    steps:
      - name: Download Home Assistant const.py
        run: |
          curl -sS https://raw.githubusercontent.com/home-assistant/core/dev/homeassistant/const.py -o const.py

      - name: Extract Python Version
        id: extract-version
        run: |
          # Extract REQUIRED_PYTHON_VER tuple from const.py
          PYTHON_TUPLE=$(grep -E "^REQUIRED_PYTHON_VER\s*=" const.py | sed -E 's/.*\(([0-9]+),\s*([0-9]+),\s*([0-9]+)\).*/\1.\2.\3/')

          if [ -z "$PYTHON_TUPLE" ]; then
            echo "Failed to extract Python version, using fallback 3.12.0"
            PYTHON_TUPLE="3.12.0"
          fi

          echo "Extracted Python version: $PYTHON_TUPLE"
          echo "python-version=$PYTHON_TUPLE" >> $GITHUB_OUTPUT

      - name: Display Python Version
        run: |
          echo "Home Assistant requires Python version: ${{ steps.extract-version.outputs.python-version }}"

  ci:
    name: CI Tests
    runs-on: ubuntu-latest
    needs: get-python-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ needs.get-python-version.outputs.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.get-python-version.outputs.python-version }}

      - name: Display Python version
        run: python --version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pytest homeassistant build

      - name: Install requirements.txt (if exists)
        run: |
          if [ -f requirements.txt ]; then
            echo "Installing requirements.txt"
            pip install -r requirements.txt
          else
            echo "No requirements.txt found, skipping"
          fi

      - name: Run Ruff (lint and format check)
        run: |
          echo "Running Ruff linter..."
          ruff check .

      - name: Run Ruff format check
        run: |
          echo "Running Ruff format check..."
          ruff format --check .

      - name: Run mypy
        run: |
          echo "Running mypy on custom_components..."
          mypy custom_components/eaton_battery_storage --ignore-missing-imports
        continue-on-error: true

      - name: Run pytest
        run: |
          echo "Running pytest..."
          pytest -v
        continue-on-error: true

      - name: Build package
        run: |
          echo "Building package..."
          python -m build
        continue-on-error: true

      - name: Summary
        if: always()
        run: |
          echo "CI pipeline completed!"
          echo "Python version used: ${{ needs.get-python-version.outputs.python-version }}"
